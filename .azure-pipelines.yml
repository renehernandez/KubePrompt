pr:
  - master

resources:
  - repo: self

variables:
  vmImageName: 'ubuntu-latest'
  GitVersion.SemVer: ''

stages:
  pool:
    vmImage: $(vmImageName)

  - stage: GitVersion
    jobs:
    - job: GitVersion
      steps:
      - task: gittools.gitversion.gitversion-task.GitVersion@5
        inputs:
          useConfigFile: true
          configFilePath: GitVersion.yml
          
  - stage: StaticAnalysis
    jobs:
    - job: StaticAnalysis
      steps:
      - task: PowerShell@2
        inputs:
          filePath: ./build.ps1 
          arguments: -Task StaticAnalysis
          
  - stage: Build
    jobs:
    - job: Build      
      steps:
      - task: PowerShell@2
        inputs:
          filePath: ./build.ps1
          arguments: -Task Build

  - stage: Test
    jobs:
    - job: Test
      strategy:
        maxParallel: 3
        matrix:
          Linux:
            vmImage: 'ubuntu-16.04'
          MacOS:
            vmImage: 'macOS-10.14'
          Windows:
            vmImage: 'windows-2019'
      pool:
        vmImage: $(vmImage)

      steps:
      - task: PowerShell@2
        inputs:
          filePath: ./build.ps1
          arguments: -Task Tests

  - stage: Publish
    jobs:
    - job: Publish      
      condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
      steps:
      - task: PowerShell@2
        inputs:
          filePath: ./build.ps1
          arguments: -Task Publish
